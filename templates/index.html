<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>TraceSIR Agent Demo Web</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e5e7eb;
      --primary: #2563eb;
      --success: #16a34a;
      --warning: #d97706;
      --text: #111827;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 20px 32px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      font-size: 20px;
      font-weight: 600;
    }

    main {
      display: flex;
      height: calc(100vh - 72px);
    }

    .left-panel {
      width: 40%;
      padding: 24px;
      overflow-y: auto;
    }

    .right-panel {
      width: 60%;
      padding: 24px;
      border-left: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    h2 {
      margin-top: 0;
      font-size: 16px;
    }

    input[type="file"],
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    button {
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      opacity: 0.9;
    }

    code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .status-box {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fafafa;
      font-size: 13px;
    }

    .status-row {
      margin-bottom: 6px;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e5e7eb;
    }

    .badge.running {
      background: #fde68a;
    }

    .badge.finished {
      background: #bbf7d0;
    }

    .logs {
      margin-top: 6px;
      background: #f9fafb;
      padding: 8px;
      max-height: 160px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 12px;
      border-radius: 6px;
    }

    .log-header {
      color: var(--text);
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 500;
    }

    #liveLogs {
      flex: 1;
      background: #ffffff;
      color: #111827;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow-y: auto;
      font-family: "JetBrains Mono", Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }

    .form-group label {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    .form-group input {
      height: 38px;
      padding: 0 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;

      line-height: 38px;
      box-sizing: border-box;
      display: block;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .masked-input {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      -webkit-text-security: disc;
    }

    #readmeToggle {
      position: fixed;
      top: 14px;
      right: 18px;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      z-index: 1000;
    }

    #readmeToggle:hover {
      background: var(--bg);
    }

    #readmeDrawer {
      position: fixed;
      top: 0;
      right: -420px;
      width: 420px;
      height: 100vh;
      background: #ffffff;
      border-left: 1px solid var(--border);
      box-shadow: -8px 0 24px rgba(0,0,0,0.08);
      transition: right 0.3s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
    }

    #readmeDrawer.open {
      right: 0;
    }

    .readme-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .readme-header button {
      background: transparent;
      color: var(--muted);
      font-size: 16px;
      padding: 4px 8px;
    }

    #readmeContent {
      padding: 16px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .markdown-body {
      padding: 16px;
      font-size: 14px;
    }

    .markdown-body pre {
      background: #f6f8fa;
      padding: 12px;
      border-radius: 6px;
    }

    .report-console {
      flex: 1;
      background: #0f172a;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      font-family: "JetBrains Mono", Consolas, monospace;
      font-size: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .report-console .user {
      color: #38bdf8;
    }

    .report-console .system {
      color: #a7f3d0;
    }

    .report-console .error {
      color: #fca5a5;
    }

    .report-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .report-input span {
      color: #94a3b8;
      font-family: monospace;
    }

    .report-input input {
      flex: 1;
      height: 36px;
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 0 10px;
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>

<header>
  TraceSIR Agent Demo
</header>

<main>
  <section class="left-panel">

    <div class="card">
      <h2>ğŸ§  LLM é…ç½®</h2>
      <div class="form-group">
        <label>Model</label>
        <input
          type="text"
          id="llmModel"
          placeholder="ä¾‹å¦‚ï¼šglm-4.6 / gpt-4o-mini"
          value="glm-4.6"
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>API Key</label>
          <input
            type="text"
            id="llmApiKey"
            class="masked-input"
            placeholder="sk-********"
          />
        </div>

        <div class="form-group">
          <label>Base URL</label>
          <input
            type="text"
            id="llmBaseUrl"
            placeholder="https://api.openai.com/v1"
          />
        </div>
      </div>

      <div class="form-hint">
        è¯¥é…ç½®ä»…ç”¨äº <b>å½“å‰ä»»åŠ¡</b>ï¼Œä¸ä¼šå†™å…¥æœåŠ¡å™¨ç¯å¢ƒå˜é‡
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“¤ ä¸Šä¼ åˆ†ææ–‡ä»¶</h2>
      <input type="file" id="fileInput" />
      <div class="form-group" style="margin-top: 12px;">
      <label>ğŸ“„ æŠ¥å‘Šç”Ÿæˆçš„ç‰¹æ®Šéœ€æ±‚ï¼ˆå¯é€‰ï¼‰</label>
      <textarea
        id="reportRequirement"
        placeholder="ä¾‹å¦‚ï¼šç”¨è‹±æ–‡ç”ŸæˆæŠ¥å‘Šï¼›æ ¹æ®otherå­—æ®µçš„xxxä¿¡æ¯ç”ŸæˆæŠ¥å‘Š..."
        rows="4"
        style="
          width: 100%;
          padding: 10px 12px;
          border-radius: 8px;
          border: 1px solid var(--border);
          font-size: 13px;
          resize: vertical;
          line-height: 1.5;
        "
      ></textarea>
      <div class="form-hint">
        ç•™ç©ºè¡¨ç¤ºä½¿ç”¨é»˜è®¤æŠ¥å‘Šç”Ÿæˆé€»è¾‘ï¼Œé»˜è®¤ç”Ÿæˆä¸­æ–‡æŠ¥å‘Š
      </div>
    </div>
      <button onclick="upload()">åˆ›å»ºä»»åŠ¡</button>
      <p id="uploadResult"></p>
    </div>

    <div class="card">
      <h2>ğŸ” æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</h2>
      <input type="text" id="jobIdInput" placeholder="è¾“å…¥ job_id" />
      <button onclick="checkStatus()">æŸ¥è¯¢çŠ¶æ€</button>
      <div id="statusResult"></div>
    </div>

    <div class="card">
      <h2>ğŸ“¦ ä¸‹è½½åˆ†æç»“æœ</h2>
      <input type="text" id="downloadJobId" placeholder="è¾“å…¥ job_id" />
      <button onclick="download()">ä¸‹è½½ç»“æœ</button>
    </div>

    <div class="card">
      <h2>ğŸ” é‡è·‘å·²æœ‰ä»»åŠ¡</h2>
      <input
        type="text"
        id="rerunJobId"
        placeholder="è¾“å…¥ job_id"
      />
      <div class="form-group" style="margin-top: 12px;">
      <label>ğŸ“„ æŠ¥å‘Šç”Ÿæˆçš„ç‰¹æ®Šéœ€æ±‚ï¼ˆå¯é€‰ï¼‰</label>
      <textarea
        id="rerunReportRequirement"
        placeholder="ä¾‹å¦‚ï¼šç”¨è‹±æ–‡ç”ŸæˆæŠ¥å‘Šï¼›æ ¹æ®otherå­—æ®µçš„xxxä¿¡æ¯ç”ŸæˆæŠ¥å‘Š..."
        rows="4"
        style="
          width: 100%;
          padding: 10px 12px;
          border-radius: 8px;
          border: 1px solid var(--border);
          font-size: 13px;
          resize: vertical;
          line-height: 1.5;
        "
      ></textarea>
      <div class="form-hint">
        ç•™ç©ºè¡¨ç¤ºä½¿ç”¨é»˜è®¤æŠ¥å‘Šç”Ÿæˆé€»è¾‘ï¼Œé»˜è®¤ç”Ÿæˆä¸­æ–‡æŠ¥å‘Š
      </div>
    </div>
      <button onclick="rerunJob()">é‡è·‘ä»»åŠ¡</button>
      <p id="rerunResult"></p>
    </div>

  </section>


  <section class="right-panel">
    <div class="log-header">
      ğŸ“¡ ä»»åŠ¡æ—¥å¿—
      <span style="color: var(--muted); font-size: 12px; margin-left: 6px;">
        ï¼ˆAgent Runtimeï¼‰
      </span>
    </div>
    <pre id="liveLogs" style="flex: 0 0 35%;"></pre>
    <div class="log-header" style="margin-top: 14px;">
      ğŸ’¬ æŠ¥å‘Šä¿®æ”¹ï¼ˆReport Consoleï¼‰
    </div>

    <div id="reportConsole" class="report-console"></div>

    <div class="report-input">
      <span>&gt;</span>
      <input
        type="text"
        id="reportCommand"
        placeholder="åˆæ¬¡ä½¿ç”¨æ—¶è¯·ç¡®ä¿é¦–å…ˆè¾“å…¥job_idï¼Œè¿”å›åˆå§‹æŠ¥å‘Šåå†è¿›è¡Œéœ€æ±‚å¯¹è¯ã€‚"
        onkeydown="if(event.key==='Enter'){sendReportCommand()}"
      />
      <button onclick="sendReportCommand()">å‘é€</button>
    </div>
  </section>
</main>


<div id="readmeToggle" title="æŸ¥çœ‹ README">
  ğŸ“˜
</div>

<aside id="readmeDrawer">
  <div class="readme-header">
    <span>ğŸ“– README</span>
    <button onclick="toggleReadme()">âœ•</button>
  </div>
  <div id="readmeContent">
åŠ è½½ä¸­...
  </div>
</aside>


<script>
  let currentEventSource = null;

  async function loadHistory(jobId) {
    const resp = await fetch("/jobs/" + jobId);
    if (!resp.ok) {
      document.getElementById("liveLogs").textContent =
        "âŒ æ— æ³•åŠ è½½å†å²æ—¥å¿—ï¼ˆjob ä¸å­˜åœ¨æˆ–å·²å¤±è´¥ï¼‰";
      return;
    }
    const data = await resp.json();

    const logBox = document.getElementById("liveLogs");
    logBox.textContent = "";

    if (data.result?.logs) {
      data.result.logs.forEach(line => {
        logBox.textContent += line + "\n";
      });
    }
  }

  async function attachLogs(jobId) {
    if (currentEventSource) {
      currentEventSource.close();
      currentEventSource = null;
    }

    localStorage.setItem("current_job_id", jobId);

    await loadHistory(jobId);
    startLogStream(jobId);
  }

  async function upload() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
      alert("è¯·é€‰æ‹©æ–‡ä»¶");
      return;
    }

    const model = document.getElementById("llmModel").value.trim();
    const apiKey = document.getElementById("llmApiKey").value.trim();
    const baseUrl = document.getElementById("llmBaseUrl").value.trim();

    if (!model || !apiKey || !baseUrl) {
      alert("è¯·å®Œæ•´å¡«å†™ LLM é…ç½®ï¼ˆModel / API Key / Base URLï¼‰");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    const reportRequirement =
    document.getElementById("reportRequirement").value.trim();
    formData.append("llm_model", model);
    formData.append("llm_api_key", apiKey);
    formData.append("llm_base_url", baseUrl);
    formData.append("report_requirement", reportRequirement);

    localStorage.setItem("llm_model", model);
    localStorage.setItem("llm_api_key", apiKey);
    localStorage.setItem("llm_base_url", baseUrl);

    const resp = await fetch("/jobs", {
      method: "POST",
      body: formData
    });

    const data = await resp.json();
    const jobId = data.job_id;

    document.getElementById("uploadResult").innerHTML =
      "âœ… job_id: <code>" + jobId + "</code>";

    attachLogs(jobId);
  }

  async function checkStatus() {
    const jobId = document.getElementById("jobIdInput").value.trim();
    const container = document.getElementById("statusResult");

    if (!jobId) {
      alert("è¯·è¾“å…¥ job_id");
      return;
    }

    container.innerHTML = "â³ æŸ¥è¯¢ä¸­...";

    try {
      const resp = await fetch("/jobs/" + jobId);
      if (!resp.ok) {
        container.innerHTML = "âŒ æŸ¥è¯¢å¤±è´¥ï¼ŒçŠ¶æ€ç : " + resp.status;
        return;
      }

      const data = await resp.json();

      const badgeClass =
        data.state === "finished" ? "badge finished" :
        data.state === "running" ? "badge running" :
        "badge";

      const logsHtml = data.result?.logs
        ? data.result.logs.map(l => "â€¢ " + l).join("\n")
        : "æš‚æ— æ—¥å¿—";

      container.innerHTML = `
        <div class="status-box">
          <div class="status-row"><b>Job IDï¼š</b>${data.job_id}</div>
          <div class="status-row">
            <b>çŠ¶æ€ï¼š</b>
            <span class="${badgeClass}">${data.state}</span>
          </div>
          <div class="status-row">
            <b>åˆ›å»ºæ—¶é—´ï¼š</b>${new Date(data.created_at * 1000).toLocaleString()}
          </div>
          <div class="status-row">
            <b>æ›´æ–°æ—¶é—´ï¼š</b>${new Date(data.updated_at * 1000).toLocaleString()}
          </div>
          ${data.result ? `
          <div class="status-row">
            <b>å¤„ç†æ–‡ä»¶æ•°ï¼š</b>${data.result.total_files}
          </div>
          ` : ""}
          <details>
            <summary>ğŸ” æŸ¥çœ‹åŸå§‹ JSON</summary>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </details>
        </div>
      `;

      attachLogs(jobId);

    } catch (err) {
      container.innerHTML = "âŒ è¯·æ±‚å¼‚å¸¸ï¼š" + err;
    }
  }

  function download() {
    const jobId = document.getElementById("downloadJobId").value.trim();
    if (!jobId) {
      alert("è¯·è¾“å…¥ job_id");
      return;
    }
    window.location.href = "/jobs/" + jobId + "/download";
  }

  function startLogStream(jobId) {
    const logBox = document.getElementById("liveLogs");

    const evtSource = new EventSource("/jobs/" + jobId + "/stream");
    currentEventSource = evtSource;

    evtSource.onmessage = async function (e) {
      if (e.data === "[[DONE]]") {
        logBox.textContent += "âœ… ä»»åŠ¡å®Œæˆ\n";
        evtSource.close();

        appendReportLine("âœ… ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ­£åœ¨åŠ è½½æœ€æ–°æŠ¥å‘Š...", "system");

        if (reportCurrentJobId) {
          await loadConcludeReport(reportCurrentJobId);
        }

        return;
      }

      logBox.textContent += e.data + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    evtSource.onerror = function () {
      evtSource.close();
    };
  }

  window.addEventListener("load", () => {
    const jobId = localStorage.getItem("current_job_id");
    if (jobId) {
      attachLogs(jobId);
    }

    const model = localStorage.getItem("llm_model");
    const apiKey = localStorage.getItem("llm_api_key");
    const baseUrl = localStorage.getItem("llm_base_url");

    if (model) document.getElementById("llmModel").value = model;
    if (apiKey) document.getElementById("llmApiKey").value = apiKey;
    if (baseUrl) document.getElementById("llmBaseUrl").value = baseUrl;
  });


  let readmeLoaded = false;

  function toggleReadme() {
    const drawer = document.getElementById("readmeDrawer");
    drawer.classList.toggle("open");

    if (drawer.classList.contains("open") && !readmeLoaded) {
      loadReadme();
      readmeLoaded = true;
    }
  }

  document.getElementById("readmeToggle")
    .addEventListener("click", toggleReadme);

  async function loadReadme() {
    const box = document.getElementById("readmeContent");
    try {
      const resp = await fetch("/readme");
      if (!resp.ok) {
        box.innerHTML = "<p>âŒ README åŠ è½½å¤±è´¥</p>";
        return;
      }
      box.innerHTML = await resp.text();
    } catch (e) {
      box.innerHTML = "<p>âŒ è¯·æ±‚å¼‚å¸¸</p>";
    }
  }

  async function rerunJob() {
    const jobId = document.getElementById("rerunJobId").value.trim();
    if (!jobId) {
      alert("è¯·è¾“å…¥ job_id");
      return;
    }
    const model = document.getElementById("llmModel").value.trim();
    const apiKey = document.getElementById("llmApiKey").value.trim();
    const baseUrl = document.getElementById("llmBaseUrl").value.trim();
    if (!model || !apiKey || !baseUrl) {
      alert("è¯·å…ˆåœ¨ä¸Šæ–¹å¡«å†™ LLM é…ç½®");
      return;
    }
    const reportRequirement =
      document.getElementById("rerunReportRequirement").value.trim();
    const formData = new FormData();
    formData.append("llm_model", model);
    formData.append("llm_api_key", apiKey);
    formData.append("llm_base_url", baseUrl);
    formData.append("report_requirement", reportRequirement);
    const resp = await fetch(`/jobs/${jobId}/rerun`, {
      method: "POST",
      body: formData
    });
    if (!resp.ok) {
      document.getElementById("rerunResult").textContent =
        "âŒ é‡è·‘å¤±è´¥";
      return;
    }
    const data = await resp.json();
    document.getElementById("rerunResult").innerHTML =
      "âœ… å·²é‡è·‘ä»»åŠ¡ï¼Œjob_id: <code>" + data.job_id + "</code>";
    attachLogs(jobId);
  }


  let reportCurrentJobId = null;

  function appendReportLine(text, cls = "system") {
    const box = document.getElementById("reportConsole");
    const line = document.createElement("div");
    line.className = cls;
    line.textContent = text;
    box.appendChild(line);
    box.scrollTop = box.scrollHeight;
  }

  
  async function sendReportCommand() {
    const input = document.getElementById("reportCommand");
    const cmd = input.value.trim();
    if (!cmd) return;
    input.value = "";

    appendReportLine("> " + cmd, "user");

    if (!reportCurrentJobId) {
      reportCurrentJobId = cmd;
      await loadConcludeReport(cmd);
      return;
    }

    await sendNewReportRequirement(reportCurrentJobId, cmd);
  }


  async function loadConcludeReport(jobId) {
    try {
      const resp = await fetch(`/jobs/${jobId}/conclude_report`);
      const data = await resp.json();
      if (!resp.ok) {
        appendReportLine(data.detail || "âŒ æŠ¥å‘Šä¸å­˜åœ¨", "error");
        return;
      }
      appendReportLine("ğŸ“„ conclude_report.md:\n", "system");
      appendReportLine(data.content, "system");
    } catch (e) {
      appendReportLine("âŒ è¯·æ±‚å¤±è´¥", "error");
    }
  }


  async function sendNewReportRequirement(jobId, requirement) {
    try {
      const resp = await fetch(`/jobs/${jobId}/report_requirement`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requirement })
      });
      const data = await resp.json();
      if (!resp.ok) {
        appendReportLine(data.detail || "âŒ å†™å…¥å¤±è´¥", "error");
        return;
      }
      appendReportLine("âœ… å·²æäº¤æŠ¥å‘Šä¿®æ”¹éœ€æ±‚", "system");
      attachLogs(jobId);
    } catch (e) {
      appendReportLine("âŒ è¯·æ±‚å¼‚å¸¸", "error");
    }
  }
  

</script>

</body>
</html>